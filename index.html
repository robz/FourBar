<html>
<style>
body {
    text-align: center;
}

.configinput {
    width: 30px;
}

canvas {
    margin: 1px 0px 0px 0px;
    padding: 0px 0px 0px 0px;
}
</style>
<h3>Four-bar simulator</h3>
click and drag gray area<br/>
<div id="container"></div>
<div id="a_input"></div>
<div id="b_input"></div>
<div id="c_input"></div>
<div id="e_input"></div>
<div id="theta5_input"></div>
<script src="../Plot.js/plot.js"></script>
<script src="fourbar.js"></script>
<script src="scrollbar.js"></script>
<script>
(function () {
    "use strict";

    var plot = new Plot({
            container: "container",
            pixelWidth: 500,
            pixelHeight: 400,
            minX: -8,
            maxX: 12,
            minY: -10,
            maxY: 8,
            pointRadius: 0.2,
            lineWidth: 0.1,
            drawColor: "blue",
            backgroundColor: "lightGray"
        }),
        
        DT = 30,
        
        count = 0,
        maxCount = 200,
        speed = 2,
        
        omega2 = (Math.PI*2)/((maxCount/speed)*DT),
        
        blockHeight = 1,
        blockWidth = 1.5,
        
        a = 1,
        b = 4,
        c = 3,
        d = 3,
        e = 6,
        theta5 = Math.PI + Math.PI / 6,
        
        fb = createFourBar(a, b, c, d, e, 0, theta5);
    
    plot.drawPoint(0, 0);
    plot.pushBackground();
    
    [{name:"a_input", field: "a", min: 0, max: 10, start: a},
     {name:"b_input", field: "b", min: 0, max: 10, start: b}, 
     {name:"c_input", field: "c", min: 0, max: 10, start: c}, 
     {name:"e_input", field: "e", min: 0, max: 10, start: e},
     {name:"theta5_input", field: "theta5", min: 0, max: Math.PI*2, start: theta5}]
    .forEach(function (elem) {
        var bar = new ScrollBar({
            container: elem.name,
            pixelWidth: 500,
            pixelHeight: 50,
            minX: elem.min,
            maxX: elem.max,
            startX:elem.start,
            drawColor: "darkGray",
            backgroundColor: "lightGray",
            movedToCallback: function (x) {
                var tmp = fb[elem.field];
                fb[elem.field] = x;
                try {
                    drawPath(calcPoints(), "red");
                } catch (exception) {
                    fb[elem.field] = tmp;
                    bar.setPosition(tmp);
                }
            }, 
        });
    });
    
    var draggingBlock = false,
        pressStartX = null,
        goalPath = [];
        
    var calcPoints = function () {
        var points = [];
        
        for (var i = 0; i < maxCount+1; i++) {
            var theta2 = i * Math.PI * 2 / maxCount;
            fb.calcPositions(theta2);
            points.push([fb.x5, fb.y5]);
        }
        
        return points;
    };

    var drawPath = function (points, color) {
        plot.popBackground();
        plot.drawPoint(0, 0);
        plot.drawPath(points, {drawColor:color});
        plot.pushBackground();
    };
    
    var makingGoalPath = false;
    
    plot.setMouseDown(function (x, y) {
        if (x > fb.d - blockWidth/2 && x < fb.d + blockWidth/2 && 
            y > -blockHeight/2 && y < blockWidth/2) 
        {
            draggingBlock = true;
            pressStartX = x;
        } else {
            goalPath = [[x,y]];
            makingGoalPath = true;
        }
    });
    
    var drawnGoalPath = false;
    
    plot.setMouseUp(function (x, y) {
        if (draggingBlock) {
            var deltaX = x - pressStartX;
            fb.d += deltaX;
            try {
                drawPath("red");
            } catch (e) {
                fb.d -= deltaX;
            }
        } else if (goalPath.length > 0) {
            if (drawnGoalPath) {
                plot.popBackground();
            }
            drawnGoalPath = true;
            drawPath(goalPath, "black");
            plot.pushBackground();
            makingGoalPath = false;
            optimize();
        }
        draggingBlock = false;
    });
    
    plot.setMouseMove(function (x, y) {
        if (draggingBlock) {
            var deltaX = x - pressStartX;
            fb.d += deltaX;
            try {
                drawPath("red");
                pressStartX = x;
            } catch (e) {
                fb.d -= deltaX;
            }
        } else if (goalPath.length > 0 && makingGoalPath) {
            goalPath.push([x,y]);
        }
    });
    
    var drawFourBarPositions = function () {
        plot.restoreToBackground();
        
        plot.drawRect(fb.d - blockWidth/2, -blockHeight/2, blockWidth, blockHeight, 
            {drawColor:"gray"});
        plot.drawPoint(fb.d, 0);
        plot.drawLine(0, 0, fb.d, 0);
        
        plot.drawPoint(fb.x2, fb.y2, {drawColor:"green"});
        plot.drawLine(0, 0, fb.x2, fb.y2);
        
        plot.drawPoint(fb.x3, fb.y3, {drawColor:"green"});
        plot.drawLine(fb.x2, fb.y2, fb.x3, fb.y3, {drawColor:"green"});
        plot.drawLine(fb.x3, fb.y3, fb.d, 0);
        
        plot.drawPoint(fb.x5, fb.y5, {drawColor:"green"});
        plot.drawLine(fb.x3, fb.y3, fb.x5, fb.y5, {drawColor:"green"});
        
        plot.drawLine(fb.x2, fb.y2, fb.x5, fb.y5, {drawColor:"green"});
    };

    var drawFourBarVelocities = function () {
        [{theta: fb.theta2, r: fb.a, omega: fb.omega2, x: 0, y: 0},
         {theta: fb.theta3, r: fb.b/2, omega: fb.omega3, x: fb.x2, y: fb.y2},
         {theta: fb.theta4, r: fb.c/2, omega: fb.omega4, x: fb.d, y: 0}].forEach(
        function (e) {
            var thetab = e.theta + e.omega*1000,
                xb = e.x + e.r*Math.cos(thetab),
                yb = e.y + e.r*Math.sin(thetab);

            plot.drawArc(e.x, e.y, e.r, e.theta, thetab, e.omega < 0, {drawColor:"black"});
            plot.drawArrowHead(xb, yb, thetab + Math.PI/2*((e.omega < 0) ? -1 : 1), {drawColor:"black"});
        });
    };
    
    setInterval(function () {
        var theta2 = count * Math.PI * 2 / maxCount;
        
        fb.calcPositions(theta2);
        fb.calcVelocities(omega2);
        drawFourBarPositions();
        //drawFourBarVelocities();

        count = (count + speed) % maxCount;
    }, DT);
        
    var calcError = function () {
        var points = calcPoints();
        
        var goalError = 0;
        
        for (var i = 0; i < goalPath.length; i++) {
            var goal = goalPath[i];
            var minError = 1e1000;
            
            for (var j = 0 ; j < points.length; j++) {
                var elem = points[j];
            
                var gerr = Math.sqrt(
                           (elem[0] - goal[0])*(elem[0] - goal[0]) + 
                           (elem[1] - goal[1])*(elem[1] - goal[1])
                           );

                if (gerr < minError) { 
                    minError = gerr;
                }
            }
            
            goalError += minError;
        }
        
        goalError /= goalPath.length;
        
        var pointsError = 0;
        
        for (var i = 0; i < points.length; i++) {
            var elem = points[i];
            var minError = 1e1000;
            
            for (var j = 0 ; j < goalPath.length; j++) {
                var goal = goalPath[j];
            
                var gerr = Math.sqrt(
                           (elem[0] - goal[0])*(elem[0] - goal[0]) + 
                           (elem[1] - goal[1])*(elem[1] - goal[1])
                           );

                if (gerr < minError) { 
                    minError = gerr;
                }
            }
            
            pointsError += minError;
        }
        
        pointsError /= points.length;
        
        return 0*pointsError + 10*goalError;
    };
    
    var running = false;
    
    var optimize = function () {
        var prevError = 1e1000;
        var scale = 5;
        
        var choices = [
            {name:"a", mutate:scale*.01},
            {name:"b", mutate:scale*.01},
            {name:"c", mutate:scale*.01},
            {name:"d", mutate:scale*.01},
            {name:"e", mutate:scale*.01},
            {name:"theta5", mutate:Math.PI*2/1000}];
            
        (function f() {
            if (makingGoalPath) {
                return;
            }
            
            var lowestError = 1e100;
            var bestElements = null;
            
            for (var i = 0; i < (1<<(choices.length)); i++) {
                fb.save();
                var elements = fb.copyElements();
            
                for (var j = choices.length-1; j >= 0; j--) {
                    if ((i>>j)&1) {
                        elements[choices[j].name] += choices[j].mutate;
                    } else {
                        elements[choices[j].name] -= choices[j].mutate;
                    }
                }
                
                fb.setElements(elements);
                
                try {
                    var error = calcError();
                    
                    if (error < lowestError) {
                        bestElements = elements;
                        lowestError = error;
                    }
                } catch (ex) {};
                
                fb.restore();
            }
            
            fb.setElements(bestElements);
            drawPath(calcPoints(), "red");
            
            setTimeout(f, 10);
        })();
    };
    
    drawPath(calcPoints(), "red");
}());
</script>
</html>